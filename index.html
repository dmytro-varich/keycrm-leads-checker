<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Импорт лидов • Обновление Excel</title>
    <link rel="icon" href="./assets/icon.svg?" type="image/svg+xml" />
    <!-- SheetJS library for Excel parsing -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <style>
         :root {
            --bg: #0b0f1a;
            --card: rgba(255, 255, 255, 0.06);
            --card-strong: rgba(255, 255, 255, 0.12);
            --text: #e6e9ef;
            --muted: #a7b0c0;
            --accent1: #6ea8fe;
            /* мягкий синий */
            --accent2: #9a7bff;
            /* фиолетовый */
            --accent3: #4dd4ac;
            /* мятный */
            --danger: #ff6b6b;
            --ok: #2fd27a;
            --ring: rgba(122, 164, 255, 0.5);
            --shadow: 0 20px 60px rgba(0, 0, 0, 0.55);
        }
        
        @media (prefers-color-scheme: light) {
             :root {
                --bg: #f6f7fb;
                --card: rgba(0, 0, 0, 0.04);
                --card-strong: rgba(0, 0, 0, 0.08);
                --text: #12141a;
                --muted: #5a6270;
                --ring: rgba(90, 133, 255, 0.35);
                --shadow: 0 20px 50px rgba(10, 10, 30, 0.1);
            }
        }
        
        * {
            box-sizing: border-box;
        }
        
        html,
        body {
            height: 100%;
        }
        
        body {
            margin: 0;
            font: 16px/1.6 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Segoe UI Emoji";
            color: var(--text);
            background: radial-gradient(1200px 600px at 10% -10%, rgba(110, 168, 254, 0.2), transparent 60%), radial-gradient(1000px 600px at 100% 10%, rgba(154, 123, 255, 0.18), transparent 60%), linear-gradient(180deg, rgba(77, 212, 172, 0.08), transparent 30%), var(--bg);
            display: grid;
            place-items: start center;
        }
        
        .wrap {
            width: min(100%, 1000px);
            padding: 28px 18px 72px;
        }
        
        .hero {
            display: grid;
            gap: 8px;
            margin: 18px 0 22px;
            text-align: center;
        }
        
        h1 {
            margin: 0;
            font-weight: 750;
            letter-spacing: 0.2px;
            font-size: clamp(22px, 3.6vw, 34px);
        }
        
        .subtitle {
            font-size: clamp(14px, 1.6vw, 16px);
            color: var(--muted);
        }
        
        .panel {
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.08), rgba(255, 255, 255, 0.02));
            background-color: var(--card);
            border: 1px solid var(--card-strong);
            border-radius: 22px;
            box-shadow: var(--shadow);
            padding: clamp(18px, 3vw, 28px);
            backdrop-filter: saturate(120%) blur(6px);
        }
        
        .grid {
            display: grid;
            grid-template-columns: 1.2fr 0.8fr;
            gap: clamp(16px, 3vw, 26px);
        }
        
        @media (max-width: 880px) {
            .grid {
                grid-template-columns: 1fr;
            }
        }
        /* Upload Card */
        
        .dropzone {
            position: relative;
            border: 2px dashed rgba(255, 255, 255, 0.22);
            border-radius: 18px;
            padding: clamp(22px, 3vw, 34px);
            display: grid;
            place-items: center;
            gap: 12px;
            text-align: center;
            transition: 0.25s ease;
            background: radial-gradient(600px 180px at 50% 0, rgba(110, 168, 254, 0.12), transparent 70%), linear-gradient(180deg, rgba(255, 255, 255, 0.06), transparent 40%);
            cursor: pointer;
            min-height: 240px;
        }
        
        .dropzone.dragover {
            border-color: transparent;
            box-shadow: inset 0 0 0 2px var(--ring), 0 10px 30px rgba(110, 168, 254, 0.15);
            transform: translateY(-1px);
            background: radial-gradient(600px 220px at 50% 0, rgba(110, 168, 254, 0.22), transparent 70%), linear-gradient(180deg, rgba(255, 255, 255, 0.1), transparent 40%);
        }
        
        .dz-icon {
            width: 62px;
            height: 62px;
            opacity: 0.95;
            filter: drop-shadow(0 6px 16px rgba(0, 0, 0, 0.25));
        }
        
        .dz-title {
            font-weight: 700;
            font-size: 18px;
        }
        
        .dz-sub {
            color: var(--muted);
            font-size: 14px;
        }
        
        .btns {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .btn {
            appearance: none;
            border: 0;
            cursor: pointer;
            padding: 10px 14px;
            border-radius: 12px;
            font-weight: 650;
            background: linear-gradient(180deg, var(--accent1), var(--accent2));
            color: white;
            box-shadow: 0 10px 30px rgba(110, 168, 254, 0.25);
            transition: transform 0.06s ease, filter 0.2s ease;
        }
        
        .btn:hover {
            filter: brightness(1.05);
        }
        
        .btn:active {
            transform: translateY(1px);
        }
        
        .btn.secondary {
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.14), rgba(255, 255, 255, 0.08));
            color: var(--text);
            border: 1px solid var(--card-strong);
            box-shadow: none;
        }
        
        .btn.ghost {
            background: transparent;
            border: 1px dashed var(--card-strong);
        }
        
        .hint {
            color: var(--muted);
            font-size: 12px;
            text-align: center;
            margin-top: 6px;
        }
        /* Details */
        
        .details {
            display: grid;
            gap: 12px;
        }
        
        .row {
            display: grid;
            gap: 6px;
        }
        
        .label {
            color: var(--muted);
            font-size: 13px;
        }
        
        .value {
            background: rgba(255, 255, 255, 0.06);
            border: 1px solid var(--card-strong);
            border-radius: 12px;
            padding: 10px 12px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            min-height: 44px;
        }
        
        .value b {
            font-weight: 750;
        }
        
        .chips {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .chip {
            padding: 6px 10px;
            border-radius: 999px;
            font-size: 12px;
            border: 1px solid var(--card-strong);
            background: rgba(255, 255, 255, 0.06);
        }
        
        .status {
            font-weight: 700;
        }
        
        .status.ok {
            color: var(--ok);
        }
        
        .status.err {
            color: var(--danger);
        }
        /* Footer */
        
        .footer {
            margin-top: 24px;
            color: var(--muted);
            font-size: 13px;
            text-align: center;
        }
        
        input[type="file"] {
            display: none;
        }
        
        a.link {
            color: var(--accent1);
            text-decoration: none;
        }
        
        a.link:hover {
            text-decoration: underline;
        }
    </style>
</head>

<body>
    <div class="wrap">
        <header class="hero">
            <h1>Импорт лидов • Обновление Excel</h1>
            <p class="subtitle">
                Загрузите исходный файл (.xlsx/.xls/.csv) — получите обновлённый Excel без дублей по данным из KeyCRM.
            </p>
        </header>

        <section class="grid">
            <!-- Upload / Primary Card -->
            <div class="panel">
                <label for="file-input" class="dropzone" id="dropzone" tabindex="0" aria-label="Перетащите Excel сюда или нажмите, чтобы выбрать файл" role="button">
                        <!-- Cloud / Upload Icon -->
                        <svg
                            class="dz-icon"
                            viewBox="0 0 24 24"
                            fill="none"
                            xmlns="http://www.w3.org/2000/svg"
                            aria-hidden="true"
                        >
                            <path
                                d="M7 18a4 4 0 0 1 0-8 5 5 0 0 1 9.58-1.65A4.5 4.5 0 1 1 19 18H7Z"
                                stroke="currentColor"
                                stroke-width="1.5"
                            />
                            <path
                                d="M12 13V6m0 0-3 3m3-3 3 3"
                                stroke="currentColor"
                                stroke-width="1.5"
                                stroke-linecap="round"
                            />
                        </svg>
                        <div class="dz-title">Перетащите файл Excel сюда</div>
                        <div class="dz-sub">или нажмите — <strong>выберите файл</strong> на устройстве</div>
                        <div class="btns" style="margin-top: 10px">
                            <button class="btn" type="button" id="chooseBtn">Выбрать файл</button>
                            <button class="btn secondary" type="button" id="resetBtn">Сбросить</button>
                        </div>
                        <input id="file-input" type="file" accept=".xlsx,.xls,.xlsm,.csv" />
                        <p class="hint">Поддерживаются: .xlsx, .xls, .xlsm, .csv • Макс. 20 МБ</p>
                    </label>
            </div>

            <!-- Details / Actions Card -->
            <div class="panel details" aria-live="polite">
                <div class="row">
                    <div class="label">Выбранный файл</div>
                    <div class="value" id="fileMeta">
                        <span>—</span>
                        <span class="chips" id="chips"></span>
                    </div>
                </div>
                <div class="row">
                    <div class="label">Статус подготовки</div>
                    <div class="value">
                        <span class="status" id="status">Ожидаю файл…</span>
                    </div>
                </div>
                <div class="row">
                    <div class="label">Действия</div>
                    <div class="value" style="justify-content: flex-start; gap: 10px">
                        <button class="btn" id="processBtn" disabled>
                                <!-- Download icon -->
                                <svg
                                    width="18"
                                    height="18"
                                    viewBox="0 0 24 24"
                                    fill="none"
                                    xmlns="http://www.w3.org/2000/svg"
                                    style="vertical-align: middle; margin-right: 8px"
                                >
                                    <path
                                        d="M12 3v10m0 0 4-4m-4 4-4-4"
                                        stroke="currentColor"
                                        stroke-width="1.6"
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                    />
                                    <path
                                        d="M5 21h14a2 2 0 0 0 2-2v-3"
                                        stroke="currentColor"
                                        stroke-width="1.6"
                                        stroke-linecap="round"
                                    />
                                </svg>
                                Обработать и скачать Excel
                            </button>
                        <button class="btn secondary" id="templateBtn" type="button">Скачать шаблон Excel</button>
                    </div>
                    <!-- <div class="hint">
                        Шаблон соответствует стандарту Gravity (порядок колонок и формат значений). Проверки дублей и нормализация телефонов будут включены позже.
                    </div> -->
                </div>
                <!-- <div class="row">
                    <div class="label">Подсказки</div>
                    <div class="value" style="flex-direction: column; align-items: flex-start; gap: 6px">
                        <div>• Файл желательно с телефонами в формате <b>+380XXXXXXXXX</b>.</div>
                        <div>• После интеграции API здесь появится индикатор проверки дублей и отчёт.</div>
                    </div>
                </div> -->
            </div>
        </section>
    </div>

    <script>
        const dz = document.getElementById("dropzone");
        const fileInput = document.getElementById("file-input");
        const chooseBtn = document.getElementById("chooseBtn");
        const resetBtn = document.getElementById("resetBtn");
        const processBtn = document.getElementById("processBtn");
        const templateBtn = document.getElementById("templateBtn");
        const fileMeta = document.getElementById("fileMeta");
        const chips = document.getElementById("chips");
        const statusEl = document.getElementById("status");

        let currentFile = null;
        let downloadUrl = null;

        const fmtSize = (bytes) => {
            if (!Number.isFinite(bytes)) return "—";
            const units = ["Б", "КБ", "МБ", "ГБ"];
            let i = 0;
            let v = bytes;
            while (v >= 1024 && i < units.length - 1) {
                v /= 1024;
                i++;
            }
            return `${v.toFixed(v < 10 && i > 0 ? 1 : 0)} ${units[i]}`;
        };

        const setStatus = (text, type = null) => {
            statusEl.textContent = text;
            statusEl.classList.remove("ok", "err");
            if (type) statusEl.classList.add(type);
        };

        const showMeta = (file) => {
            const name = document.createElement("span");
            name.innerHTML = `<b>${file.name}</b> · ${fmtSize(file.size)}`;
            const ext = (file.name.split(".").pop() || "").toLowerCase();
            const extChip = document.createElement("span");
            extChip.className = "chip";
            extChip.textContent = ext ? `.${ext}` : "файл";

            fileMeta.firstElementChild.replaceWith(name);
            chips.innerHTML = "";
            chips.appendChild(extChip);
        };

        const acceptExt = ["xlsx", "xls", "xlsm", "csv"];
        const validFile = (file) => {
            const ext = (file.name.split(".").pop() || "").toLowerCase();
            if (!acceptExt.includes(ext)) return false;
            const max = 20 * 1024 * 1024; // 20MB
            return file.size <= max;
        };

        const assignFile = (file) => {
            if (!validFile(file)) {
                setStatus(
                    "Неподдерживаемый тип или слишком большой файл (макс. 20 МБ).",
                    "err"
                );
                currentFile = null;
                processBtn.disabled = true;
                fileMeta.firstElementChild.textContent = "—";
                chips.innerHTML = "";
                return;
            }
            currentFile = file;
            showMeta(file);
            processBtn.disabled = false;
            setStatus("Готов к обработке");
        };

        chooseBtn.addEventListener("click", () => fileInput.click());
        fileInput.addEventListener("change", (e) => {
            const file = e.target.files && e.target.files[0];
            if (file) assignFile(file);
        });

        // Drag and drop handlers
        ["dragenter", "dragover"].forEach((evt) =>
            dz.addEventListener(evt, (e) => {
                e.preventDefault();
                e.stopPropagation();
                dz.classList.add("dragover");
            })
        );
        ["dragleave", "drop"].forEach((evt) =>
            dz.addEventListener(evt, (e) => {
                e.preventDefault();
                e.stopPropagation();
                dz.classList.remove("dragover");
            })
        );
        dz.addEventListener("drop", (e) => {
            const file =
                e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files[0];
            if (file) assignFile(file);
        });

        // Keyboard activation for accessibility
        dz.addEventListener("keydown", (e) => {
            if (e.key === "Enter" || e.key === " ") {
                e.preventDefault();
                fileInput.click();
            }
        });

        resetBtn.addEventListener("click", () => {
            currentFile = null;
            if (downloadUrl) {
                URL.revokeObjectURL(downloadUrl);
                downloadUrl = null;
            }
            fileInput.value = "";
            processBtn.disabled = true;
            setStatus("Ожидаю файл…");
            fileMeta.firstElementChild.textContent = "—";
            chips.innerHTML = "";
        });

        // Нормализация телефона (как в server.js)
        const normalizeUaPhone = (phone) => {
            let s = String(phone || "").trim();
            if (!s) return "";
            s = s.replace(/[\s()-]/g, "");
            if (s.startsWith("00")) s = "+" + s.slice(2);
            if (s.startsWith("+380")) return s;
            if (/^380\d{9}$/.test(s)) return "+" + s;
            if (/^0\d{9}$/.test(s)) return "+38" + s;
            if (s.startsWith("+")) return s;
            return s;
        };

        const normalizeEmail = (email) =>
            String(email || "")
            .trim()
            .toLowerCase();

        // Проверка дубликатов через API
        const checkDuplicates = async(parsedData) => {
            setStatus("Загрузка данных из KeyCRM...");

            try {
                // URL API сервера (автоматически определяет локальный или продакшн)
                const isLocalhost = window.location.hostname === 'localhost' ||
                    window.location.hostname === '127.0.0.1' ||
                    window.location.hostname === '';

                const API_URL = isLocalhost ?
                    "http://localhost:3000" // Для локальной разработки
                    :
                    "https://keycrm-leads-checker.onrender.com"; // ← ЗАМЕНИТЕ после деплоя на Render

                console.log(`🌐 Определён режим: ${isLocalhost ? 'ЛОКАЛЬНЫЙ' : 'ПРОДАКШН'}`);
                console.log(`🔗 API URL: ${API_URL}`);

                // ШАГ 1: Получаем всех покупателей из KeyCRM
                setStatus("Загрузка покупателей из KeyCRM...");
                const buyersResponse = await fetch(`${API_URL}/buyers/all?max=10000`);
                if (!buyersResponse.ok) {
                    throw new Error(`API error: ${buyersResponse.status}`);
                }

                const {
                    data: buyers
                } = await buyersResponse.json();
                console.log("=== BUYERS FROM KEYCRM ===");
                console.log(`Получено покупателей: ${buyers.length}`);
                console.log("Первые 3 покупателя:", buyers.slice(0, 3));

                // ШАГ 2: Получаем ВСЕ компании из KeyCRM (один раз!)
                setStatus("Загрузка компаний из KeyCRM...");
                const companiesResponse = await fetch(`${API_URL}/companies/all?max=5000`);
                if (!companiesResponse.ok) {
                    throw new Error(`API error (companies): ${companiesResponse.status}`);
                }

                const {
                    data: companies
                } = await companiesResponse.json();
                console.log("=== COMPANIES FROM KEYCRM ===");
                console.log(`Получено компаний: ${companies.length}`);
                console.log("Первые 3 компании:", companies.slice(0, 3));

                // Создаем Set для быстрого поиска по всем полям
                const existingPhones = new Set();
                const existingEmails = new Set();
                const existingSocialNetworks = new Set(); // ← НОВОЕ: для соц. сетей

                // Создаем Map для быстрого поиска ПОЛНЫХ данных покупателя по разным полям
                const buyersByPhone = new Map();
                const buyersByEmail = new Map();

                // Заполняем индексы из buyers (телефоны и email)
                buyers.forEach((buyer) => {
                    // Телефоны и email
                    buyer.phones.forEach((p) => {
                        existingPhones.add(p);
                        buyersByPhone.set(p, buyer);
                    });
                    buyer.emails.forEach((e) => {
                        existingEmails.add(e);
                        buyersByEmail.set(e, buyer);
                    });
                });

                // Заполняем индексы из companies (соц. сети)
                companies.forEach((company) => {
                    // Ищем custom_fields с названием "Соціальні мережі"
                    if (company.custom_fields && Array.isArray(company.custom_fields)) {
                        const socialField = company.custom_fields.find(
                            field => field.name === "Соціальні мережі"
                        );

                        if (socialField && socialField.value) {
                            const socialNetwork = String(socialField.value).trim().toLowerCase();
                            if (socialNetwork) {
                                existingSocialNetworks.add(socialNetwork);
                                console.log(`   ✓ Компания ID ${company.id}: "${socialNetwork}"`);
                            }
                        }
                    }
                });

                console.log(`\n📊 СТАТИСТИКА:`);
                console.log(`   Уникальних телефонів в KeyCRM: ${existingPhones.size}`);
                console.log(`   Уникальних email в KeyCRM: ${existingEmails.size}`);
                console.log(`   Уникальних соц. мереж в KeyCRM: ${existingSocialNetworks.size}`);

                setStatus("Перевірка дублікатів...");

                console.log("\n=== ПОЧАТОК ПЕРЕВІРКИ КОЖНОГО ЗАПИСУ ===");

                // Проверяем каждую запись из файла
                const results = [];

                for (let index = 0; index < parsedData.length; index++) {
                    const row = parsedData[index];

                    // Разбиваем телефоны на массив, если их несколько через запятую
                    const phoneRaw = row["Телефон"] || "";
                    const phones = phoneRaw
                        .split(/[,;]/) // Разделяем по запятой или точке с запятой
                        .map(p => normalizeUaPhone(p.trim())) // Нормализуем каждый
                        .filter(p => p); // Убираем пустые

                    // Разбиваем email тоже, если их несколько
                    const emailRaw = row["Email"] || "";
                    const emails = emailRaw
                        .split(/[,;]/)
                        .map(e => normalizeEmail(e.trim()))
                        .filter(e => e);

                    // Название компании и полное имя (для логирования)
                    const companyName = (row["Назва компанії"] || "").trim().toLowerCase();
                    const fullName = (row["Повне ім'я"] || "").trim().toLowerCase();

                    // Соц. сеть из файла - ищем колонку без учёта регистра
                    let socialNetworkRaw = "";
                    let socialColumnName = "";

                    // Ищем колонку по частичному совпадению (без учёта регистра)
                    const socialKeys = Object.keys(row).filter(key => {
                        const lowerKey = key.toLowerCase();
                        return (lowerKey.includes("соц") && lowerKey.includes("мереж"));
                    });

                    if (socialKeys.length > 0) {
                        socialColumnName = socialKeys[0];
                        socialNetworkRaw = row[socialColumnName] || "";
                    }

                    const socialNetwork = socialNetworkRaw.trim().toLowerCase();

                    // Проверяем дубликаты
                    const isDuplicateByPhone = phones.some(phone => existingPhones.has(phone));
                    const isDuplicateByEmail = emails.some(email => existingEmails.has(email));
                    const isDuplicateBySocialNetwork = socialNetwork && existingSocialNetworks.has(socialNetwork);

                    // Для совместимости с логированием (не используем для проверки дубликатов)
                    const isDuplicateByCompanyName = false;
                    const isDuplicateByFullName = false;

                    // Запись считается дубликатом если совпадает ХОТЯ БЫ ОДНО поле
                    const isDuplicate = isDuplicateByPhone || isDuplicateByEmail || isDuplicateBySocialNetwork;

                    // Формируем причину дубликата
                    const reasons = [];
                    if (isDuplicateByPhone) reasons.push("телефон");
                    if (isDuplicateByEmail) reasons.push("email");
                    if (isDuplicateBySocialNetwork) reasons.push("соц. мережа");

                    // ДЕТАЛЬНОЕ ЛОГИРОВАНИЕ КАЖДОЙ ЗАПИСИ
                    console.log(`\n--- Запись ${index + 1} (строка Excel: ${index + 2}) ---`);
                    console.log(`📋 ВСЕ КОЛОНКИ В ФАЙЛЕ:`, Object.keys(row)); // ← НОВОЕ: покажет все колонки
                    console.log(`🔍 Найдена колонка для соц. сети: "${socialColumnName || 'НЕ НАЙДЕНА'}"`); // ← НОВОЕ
                    console.log(`📋 Исходные данные из файла:`);
                    console.log(`   Телефон: "${phoneRaw || "(пусто)"}"`);
                    console.log(`   Email: "${emailRaw || "(пусто)"}"`);
                    console.log(`   Соц. мережа: "${socialNetworkRaw || "(пусто)"}"`);

                    console.log(`\n🔍 Нормализованные данные для проверки:`);
                    console.log(`   Телефоны (массив): [${phones.map(p => '"' + p + '"').join(", ")}]`);
                    console.log(`   Email (массив): [${emails.map(e => '"' + e + '"').join(", ")}]`);
                    console.log(`   Компания нормализованная: "${companyName || "(пусто)"}"`);
                    console.log(`   Полное имя нормализованное: "${fullName || "(пусто)"}"`);
                    console.log(`   Соц. мережа нормализованная: "${socialNetwork || "(пусто)"}"`); // ← НОВОЕ

                    console.log(`\n⚖️ Результаты сравнения с KeyCRM:`);
                    console.log(`   Телефон найден в базе: ${isDuplicateByPhone ? '❌ ДА (ДУБЛИКАТ)' : '✅ НЕТ (уникален)'}`);
                    if (isDuplicateByPhone) {
                        const foundPhones = phones.filter(p => existingPhones.has(p));
                        console.log(`      → Найденные телефоны: ${foundPhones.join(", ")}`);
                    }
                    console.log(`   Email найден в базе: ${isDuplicateByEmail ? '❌ ДА (ДУБЛИКАТ)' : '✅ НЕТ (уникален)'}`);
                    if (isDuplicateByEmail) {
                        const foundEmails = emails.filter(e => existingEmails.has(e));
                        console.log(`      → Найденные email: ${foundEmails.join(", ")}`);
                    }
                    console.log(`   Компания найдена в базе: ${isDuplicateByCompanyName ? '❌ ДА (ДУБЛИКАТ)' : '✅ НЕТ (уникален)'}`);
                    console.log(`   Полное имя найдено в базе: ${isDuplicateByFullName ? '❌ ДА (ДУБЛИКАТ)' : '✅ НЕТ (уникален)'}`);
                    console.log(`   Соц. мережа найдена в базе: ${isDuplicateBySocialNetwork ? '❌ ДА (ДУБЛИКАТ)' : '✅ НЕТ (уникален)'}`); // ← НОВОЕ
                    if (isDuplicateBySocialNetwork) {
                        console.log(`      → Найдена соц. мережа: "${socialNetwork}"`);
                    }
                    console.log(`\n📊 ИТОГ:`);
                    if (isDuplicate) {
                        console.log(`   ❌ ДУБЛИКАТ - причина: ${reasons.join(", ")}`);
                    } else {
                        console.log(`   ✅ УНИКАЛЬНАЯ ЗАПИСЬ - все поля не найдены в KeyCRM`);
                    }

                    // Находим полные данные покупателя из KeyCRM (по первому найденному совпадению)
                    let keyCRMBuyer = null;
                    if (isDuplicateByPhone && phones.length > 0) {
                        // Ищем по первому найденному телефону
                        const foundPhone = phones.find(p => existingPhones.has(p));
                        if (foundPhone) {
                            keyCRMBuyer = buyersByPhone.get(foundPhone);
                        }
                    } else if (isDuplicateByEmail && emails.length > 0) {
                        const foundEmail = emails.find(e => existingEmails.has(e));
                        if (foundEmail) {
                            keyCRMBuyer = buyersByEmail.get(foundEmail);
                        }
                    } else if (isDuplicateByCompanyName) {
                        keyCRMBuyer = buyersByCompanyName.get(companyName);
                    } else if (isDuplicateByFullName) {
                        keyCRMBuyer = buyersByFullName.get(fullName);
                    }
                    // Примечание: для isDuplicateBySocialNetwork покупатель уже найден выше в keyCRMBuyerForSocial

                    // Формируем объект результата
                    const result = {
                        ...row,
                        _isDuplicate: isDuplicate,
                        _duplicateReason: reasons.join(", "),
                        _rowNumber: index + 2,
                    };

                    // Если дубликат - добавляем данные из KeyCRM
                    if (isDuplicate && keyCRMBuyer) {
                        result["[KeyCRM] ID"] = keyCRMBuyer.id || "";
                        result["[KeyCRM] Назва"] = keyCRMBuyer.name || "";
                        result["[KeyCRM] Телефони"] = keyCRMBuyer.phones.join(", ") || "";
                        result["[KeyCRM] Email"] = keyCRMBuyer.emails.join(", ") || "";
                        result["[KeyCRM] Соц. мережа"] = keyCRMBuyer.socialNetworks || ""; // ← НОВОЕ
                        result["[KeyCRM] Джерело"] = keyCRMBuyer.source || "";
                        result["[KeyCRM] Менеджер"] = keyCRMBuyer.manager || "";
                        result["[KeyCRM] Теги"] = keyCRMBuyer.tags || "";
                        result["[KeyCRM] Коментар"] = keyCRMBuyer.comment || "";

                        console.log(`\n🔍 Знайдено в KeyCRM:`);
                        console.log(`   ID: ${keyCRMBuyer.id}`);
                        console.log(`   Назва: ${keyCRMBuyer.name}`);
                        console.log(`   Телефони: ${keyCRMBuyer.phones.join(", ")}`);
                        console.log(`   Email: ${keyCRMBuyer.emails.join(", ")}`);
                        console.log(`   Соц. мережа: ${keyCRMBuyer.socialNetworks || "(немає)"}`); // ← НОВОЕ
                    }

                    results.push(result);
                }

                console.log("\n=== КОНЕЦ ПРОВЕРКИ ЗАПИСЕЙ ===\n");

                const duplicates = results.filter((r) => r._isDuplicate);
                const unique = results.filter((r) => !r._isDuplicate);

                console.log("=== РЕЗУЛЬТАТЫ ПРОВЕРКИ ===");
                console.log(`Всего записей: ${results.length}`);
                console.log(`Дубликатов: ${duplicates.length}`);
                console.log(`Уникальных: ${unique.length}`);
                if (duplicates.length > 0) {
                    console.log("Примеры дубликатов:");
                    duplicates.slice(0, 5).forEach(d => {
                        console.log(`- Строка ${d._rowNumber}: "${d["Назва компанії"] || d["Повне ім'я"]}" (причина: ${d._duplicateReason})`);
                    });
                }

                return {
                    unique,
                    duplicates,
                    total: results.length
                };
            } catch (error) {
                console.error("Ошибка при проверке дубликатов:", error);
                throw new Error(`Не удалось проверить дубликаты: ${error.message}`);
            }
        };

        // Создание Excel файла
        const createExcelFile = (data, filename) => {
            // Удаляем служебные поля перед экспортом
            const cleanData = data.map((row) => {
                const {
                    _isDuplicate,
                    _duplicateReason,
                    _rowNumber,
                    ...clean
                } = row;
                return clean;
            });

            // Создаем новую книгу
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(cleanData);

            // Добавляем лист
            XLSX.utils.book_append_sheet(wb, ws, "Уникальные лиды");

            // Генерируем файл
            const wbout = XLSX.write(wb, {
                bookType: "xlsx",
                type: "array"
            });
            const blob = new Blob([wbout], {
                type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
            });

            // Создаем ссылку для скачивания
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            a.remove();
            setTimeout(() => URL.revokeObjectURL(url), 5000);
        };

        processBtn.addEventListener("click", async() => {
            if (!currentFile) return;
            setStatus("Обработка…");

            try {
                // Читаем файл как ArrayBuffer
                const arrayBuf = await currentFile.arrayBuffer();
                const ext = (currentFile.name.split(".").pop() || "").toLowerCase();

                let parsedData = [];

                // Парсим файл в зависимости от типа
                if (ext === "csv") {
                    // Для CSV файлов
                    const text = new TextDecoder("utf-8").decode(arrayBuf);
                    const lines = text.split("\n").filter((line) => line.trim());

                    if (lines.length > 0) {
                        // Первая строка - заголовки
                        const headers = lines[0]
                            .split(";")
                            .map((h) => h.trim().replace(/^\uFEFF/, ""));

                        // Остальные строки - данные
                        for (let i = 1; i < lines.length; i++) {
                            const values = lines[i].split(";");
                            const row = {};
                            headers.forEach((header, index) => {
                                row[header] = values[index] ? values[index].trim() : "";
                            });
                            parsedData.push(row);
                        }
                    }
                } else {
                    // Для Excel файлов (.xlsx, .xls, .xlsm)
                    const workbook = XLSX.read(arrayBuf, {
                        type: "array",
                    });

                    // Берем первый лист
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];

                    // Преобразуем в JSON (массив объектов)
                    parsedData = XLSX.utils.sheet_to_json(worksheet, {
                        defval: "", // Пустые ячейки будут пустыми строками
                        raw: false, // Все значения как строки
                    });
                }

                console.log("=== PARSED DATA ===");
                console.log(`Всего строк в файле: ${parsedData.length}`);

                if (parsedData.length === 0) {
                    setStatus("Файл пустой или неправильный формат", "err");
                    return;
                }

                // Проверяем дубликаты через API
                const {
                    unique,
                    duplicates,
                    total
                } = await checkDuplicates(
                    parsedData
                );

                // Создаем Excel файл только с уникальными записями
                const baseFilename = currentFile.name.replace(/\.[^.]+$/, "");
                const newFilename = `${baseFilename}_без_дублей.xlsx`;
                let reportFilename = null;

                createExcelFile(unique, newFilename);

                // Также создаем отчет с дубликатами (опционально)
                if (duplicates.length > 0) {
                    reportFilename = `${baseFilename}_дубликаты_отчет.xlsx`;
                    createExcelFile(duplicates, reportFilename);
                }

                setStatus(
                    `✔ Готово! Уникальных: ${unique.length} из ${total}. Дублей: ${duplicates.length}`,
                    "ok"
                );

                console.log("=== ФАЙЛЫ СОЗДАНЫ ===");
                console.log(
                    `1. ${newFilename} - ${unique.length} уникальных записей`
                );
                if (duplicates.length > 0 && reportFilename) {
                    console.log(
                        `2. ${reportFilename} - ${duplicates.length} дубликатов`
                    );
                }
            } catch (error) {
                console.error("Ошибка при обработке:", error);
                setStatus(`Ошибка: ${error.message}`, "err");
            }
        });

        templateBtn.addEventListener("click", () => {
            // TODO: подменить на реальный .xlsx шаблон Gravity.
            // Сейчас отдадим пустой CSV с заголовками по стандарту — чтобы было с чего начать.
            const headers = [
                "Назва компанії",
                "Телефон",
                "Регіон основний",
                "Основний вид діяльності",
                "Клас об'єктів основний",
                "Основний тип об'єктів",
                "Професійність",
                "Зацікавленість у співпраці",
                "Розмір компанії",
                "Повне ім'я",
                "Назва ліда",
                "Джерело",
                "Додаткові види діяльності",
                "Регіони додаткові",
                "Клас об'єктів додатковий",
                "Додатковий тип об'єктів",
                "Досвід роботи (років)",
                "Соціальні мережі(Компанії)",
                "Email",
                "Соціальні мережі(людина)",
                "Соц. Мережа", // ← НОВОЕ: добавлено для проверки дубликатов
            ];
            const csv = "\uFEFF" + headers.join(";") + "\n";
            const blob = new Blob([csv], {
                type: "text/csv;charset=utf-8",
            });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = "gravity_template.csv";
            document.body.appendChild(a);
            a.click();
            a.remove();
            setTimeout(() => URL.revokeObjectURL(url), 5000);
        });
    </script>
</body>

</html>