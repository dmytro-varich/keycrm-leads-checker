<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>–ò–º–ø–æ—Ä—Ç –ª–∏–¥–æ–≤ ‚Ä¢ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ Excel</title>
    <link rel="icon" href="./assets/icon.svg?" type="image/svg+xml" />
    <!-- SheetJS library for Excel parsing -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <style>
         :root {
            --bg: #0b0f1a;
            --card: rgba(255, 255, 255, 0.06);
            --card-strong: rgba(255, 255, 255, 0.12);
            --text: #e6e9ef;
            --muted: #a7b0c0;
            --accent1: #6ea8fe;
            /* –º—è–≥–∫–∏–π —Å–∏–Ω–∏–π */
            --accent2: #9a7bff;
            /* —Ñ–∏–æ–ª–µ—Ç–æ–≤—ã–π */
            --accent3: #4dd4ac;
            /* –º—è—Ç–Ω—ã–π */
            --danger: #ff6b6b;
            --ok: #2fd27a;
            --ring: rgba(122, 164, 255, 0.5);
            --shadow: 0 20px 60px rgba(0, 0, 0, 0.55);
        }
        
        @media (prefers-color-scheme: light) {
             :root {
                --bg: #f6f7fb;
                --card: rgba(0, 0, 0, 0.04);
                --card-strong: rgba(0, 0, 0, 0.08);
                --text: #12141a;
                --muted: #5a6270;
                --ring: rgba(90, 133, 255, 0.35);
                --shadow: 0 20px 50px rgba(10, 10, 30, 0.1);
            }
        }
        
        * {
            box-sizing: border-box;
        }
        
        html,
        body {
            height: 100%;
        }
        
        body {
            margin: 0;
            font: 16px/1.6 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Segoe UI Emoji";
            color: var(--text);
            background: radial-gradient(1200px 600px at 10% -10%, rgba(110, 168, 254, 0.2), transparent 60%), radial-gradient(1000px 600px at 100% 10%, rgba(154, 123, 255, 0.18), transparent 60%), linear-gradient(180deg, rgba(77, 212, 172, 0.08), transparent 30%), var(--bg);
            display: grid;
            place-items: start center;
        }
        
        .wrap {
            width: min(100%, 1000px);
            padding: 28px 18px 72px;
        }
        
        .hero {
            display: grid;
            gap: 8px;
            margin: 18px 0 22px;
            text-align: center;
        }
        
        h1 {
            margin: 0;
            font-weight: 750;
            letter-spacing: 0.2px;
            font-size: clamp(22px, 3.6vw, 34px);
        }
        
        .subtitle {
            font-size: clamp(14px, 1.6vw, 16px);
            color: var(--muted);
        }
        
        .panel {
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.08), rgba(255, 255, 255, 0.02));
            background-color: var(--card);
            border: 1px solid var(--card-strong);
            border-radius: 22px;
            box-shadow: var(--shadow);
            padding: clamp(18px, 3vw, 28px);
            backdrop-filter: saturate(120%) blur(6px);
        }
        
        .grid {
            display: grid;
            grid-template-columns: 1.2fr 0.8fr;
            gap: clamp(16px, 3vw, 26px);
        }
        
        @media (max-width: 880px) {
            .grid {
                grid-template-columns: 1fr;
            }
        }
        /* Upload Card */
        
        .dropzone {
            position: relative;
            border: 2px dashed rgba(255, 255, 255, 0.22);
            border-radius: 18px;
            padding: clamp(22px, 3vw, 34px);
            display: grid;
            place-items: center;
            gap: 12px;
            text-align: center;
            transition: 0.25s ease;
            background: radial-gradient(600px 180px at 50% 0, rgba(110, 168, 254, 0.12), transparent 70%), linear-gradient(180deg, rgba(255, 255, 255, 0.06), transparent 40%);
            cursor: pointer;
            min-height: 240px;
        }
        
        .dropzone.dragover {
            border-color: transparent;
            box-shadow: inset 0 0 0 2px var(--ring), 0 10px 30px rgba(110, 168, 254, 0.15);
            transform: translateY(-1px);
            background: radial-gradient(600px 220px at 50% 0, rgba(110, 168, 254, 0.22), transparent 70%), linear-gradient(180deg, rgba(255, 255, 255, 0.1), transparent 40%);
        }
        
        .dz-icon {
            width: 62px;
            height: 62px;
            opacity: 0.95;
            filter: drop-shadow(0 6px 16px rgba(0, 0, 0, 0.25));
        }
        
        .dz-title {
            font-weight: 700;
            font-size: 18px;
        }
        
        .dz-sub {
            color: var(--muted);
            font-size: 14px;
        }
        
        .btns {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .btn {
            appearance: none;
            border: 0;
            cursor: pointer;
            padding: 10px 14px;
            border-radius: 12px;
            font-weight: 650;
            background: linear-gradient(180deg, var(--accent1), var(--accent2));
            color: white;
            box-shadow: 0 10px 30px rgba(110, 168, 254, 0.25);
            transition: transform 0.06s ease, filter 0.2s ease;
        }
        
        .btn:hover {
            filter: brightness(1.05);
        }
        
        .btn:active {
            transform: translateY(1px);
        }
        
        .btn.secondary {
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.14), rgba(255, 255, 255, 0.08));
            color: var(--text);
            border: 1px solid var(--card-strong);
            box-shadow: none;
        }
        
        .btn.ghost {
            background: transparent;
            border: 1px dashed var(--card-strong);
        }
        
        .hint {
            color: var(--muted);
            font-size: 12px;
            text-align: center;
            margin-top: 6px;
        }
        /* Details */
        
        .details {
            display: grid;
            gap: 12px;
        }
        
        .row {
            display: grid;
            gap: 6px;
        }
        
        .label {
            color: var(--muted);
            font-size: 13px;
        }
        
        .value {
            background: rgba(255, 255, 255, 0.06);
            border: 1px solid var(--card-strong);
            border-radius: 12px;
            padding: 10px 12px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            min-height: 44px;
        }
        
        .value b {
            font-weight: 750;
        }
        
        .chips {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .chip {
            padding: 6px 10px;
            border-radius: 999px;
            font-size: 12px;
            border: 1px solid var(--card-strong);
            background: rgba(255, 255, 255, 0.06);
        }
        
        .status {
            font-weight: 700;
        }
        
        .status.ok {
            color: var(--ok);
        }
        
        .status.err {
            color: var(--danger);
        }
        /* Footer */
        
        .footer {
            margin-top: 24px;
            color: var(--muted);
            font-size: 13px;
            text-align: center;
        }
        
        input[type="file"] {
            display: none;
        }
        
        a.link {
            color: var(--accent1);
            text-decoration: none;
        }
        
        a.link:hover {
            text-decoration: underline;
        }
    </style>
</head>

<body>
    <div class="wrap">
        <header class="hero">
            <h1>–ò–º–ø–æ—Ä—Ç –ª–∏–¥–æ–≤ ‚Ä¢ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ Excel</h1>
            <p class="subtitle">
                –ó–∞–≥—Ä—É–∑–∏—Ç–µ –∏—Å—Ö–æ–¥–Ω—ã–π —Ñ–∞–π–ª (.xlsx/.xls/.csv) ‚Äî –ø–æ–ª—É—á–∏—Ç–µ –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π Excel –±–µ–∑ –¥—É–±–ª–µ–π –ø–æ –¥–∞–Ω–Ω—ã–º –∏–∑ KeyCRM.
            </p>
        </header>

        <section class="grid">
            <!-- Upload / Primary Card -->
            <div class="panel">
                <label for="file-input" class="dropzone" id="dropzone" tabindex="0" aria-label="–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ Excel —Å—é–¥–∞ –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª" role="button">
                        <!-- Cloud / Upload Icon -->
                        <svg
                            class="dz-icon"
                            viewBox="0 0 24 24"
                            fill="none"
                            xmlns="http://www.w3.org/2000/svg"
                            aria-hidden="true"
                        >
                            <path
                                d="M7 18a4 4 0 0 1 0-8 5 5 0 0 1 9.58-1.65A4.5 4.5 0 1 1 19 18H7Z"
                                stroke="currentColor"
                                stroke-width="1.5"
                            />
                            <path
                                d="M12 13V6m0 0-3 3m3-3 3 3"
                                stroke="currentColor"
                                stroke-width="1.5"
                                stroke-linecap="round"
                            />
                        </svg>
                        <div class="dz-title">–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª Excel —Å—é–¥–∞</div>
                        <div class="dz-sub">–∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ ‚Äî <strong>–≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª</strong> –Ω–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ</div>
                        <div class="btns" style="margin-top: 10px">
                            <button class="btn" type="button" id="chooseBtn">–í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª</button>
                            <button class="btn secondary" type="button" id="resetBtn">–°–±—Ä–æ—Å–∏—Ç—å</button>
                        </div>
                        <input id="file-input" type="file" accept=".xlsx,.xls,.xlsm,.csv" />
                        <p class="hint">–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è: .xlsx, .xls, .xlsm, .csv ‚Ä¢ –ú–∞–∫—Å. 20 –ú–ë</p>
                    </label>
            </div>

            <!-- Details / Actions Card -->
            <div class="panel details" aria-live="polite">
                <div class="row">
                    <div class="label">–í—ã–±—Ä–∞–Ω–Ω—ã–π —Ñ–∞–π–ª</div>
                    <div class="value" id="fileMeta">
                        <span>‚Äî</span>
                        <span class="chips" id="chips"></span>
                    </div>
                </div>
                <div class="row">
                    <div class="label">–°—Ç–∞—Ç—É—Å –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏</div>
                    <div class="value">
                        <span class="status" id="status">–û–∂–∏–¥–∞—é —Ñ–∞–π–ª‚Ä¶</span>
                    </div>
                </div>
                <div class="row">
                    <div class="label">–î–µ–π—Å—Ç–≤–∏—è</div>
                    <div class="value" style="justify-content: flex-start; gap: 10px">
                        <button class="btn" id="processBtn" disabled>
                                <!-- Download icon -->
                                <svg
                                    width="18"
                                    height="18"
                                    viewBox="0 0 24 24"
                                    fill="none"
                                    xmlns="http://www.w3.org/2000/svg"
                                    style="vertical-align: middle; margin-right: 8px"
                                >
                                    <path
                                        d="M12 3v10m0 0 4-4m-4 4-4-4"
                                        stroke="currentColor"
                                        stroke-width="1.6"
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                    />
                                    <path
                                        d="M5 21h14a2 2 0 0 0 2-2v-3"
                                        stroke="currentColor"
                                        stroke-width="1.6"
                                        stroke-linecap="round"
                                    />
                                </svg>
                                –û–±—Ä–∞–±–æ—Ç–∞—Ç—å –∏ —Å–∫–∞—á–∞—Ç—å Excel
                            </button>
                        <button class="btn secondary" id="templateBtn" type="button">–°–∫–∞—á–∞—Ç—å —à–∞–±–ª–æ–Ω Excel</button>
                    </div>
                    <!-- <div class="hint">
                        –®–∞–±–ª–æ–Ω —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç—É Gravity (–ø–æ—Ä—è–¥–æ–∫ –∫–æ–ª–æ–Ω–æ–∫ –∏ —Ñ–æ—Ä–º–∞—Ç –∑–Ω–∞—á–µ–Ω–∏–π). –ü—Ä–æ–≤–µ—Ä–∫–∏ –¥—É–±–ª–µ–π –∏ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤ –±—É–¥—É—Ç –≤–∫–ª—é—á–µ–Ω—ã –ø–æ–∑–∂–µ.
                    </div> -->
                </div>
                <!-- <div class="row">
                    <div class="label">–ü–æ–¥—Å–∫–∞–∑–∫–∏</div>
                    <div class="value" style="flex-direction: column; align-items: flex-start; gap: 6px">
                        <div>‚Ä¢ –§–∞–π–ª –∂–µ–ª–∞—Ç–µ–ª—å–Ω–æ —Å —Ç–µ–ª–µ—Ñ–æ–Ω–∞–º–∏ –≤ —Ñ–æ—Ä–º–∞—Ç–µ <b>+380XXXXXXXXX</b>.</div>
                        <div>‚Ä¢ –ü–æ—Å–ª–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ API –∑–¥–µ—Å—å –ø–æ—è–≤–∏—Ç—Å—è –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥—É–±–ª–µ–π –∏ –æ—Ç—á—ë—Ç.</div>
                    </div>
                </div> -->
            </div>
        </section>
    </div>

    <script>
        const dz = document.getElementById("dropzone");
        const fileInput = document.getElementById("file-input");
        const chooseBtn = document.getElementById("chooseBtn");
        const resetBtn = document.getElementById("resetBtn");
        const processBtn = document.getElementById("processBtn");
        const templateBtn = document.getElementById("templateBtn");
        const fileMeta = document.getElementById("fileMeta");
        const chips = document.getElementById("chips");
        const statusEl = document.getElementById("status");

        let currentFile = null;
        let downloadUrl = null;

        const fmtSize = (bytes) => {
            if (!Number.isFinite(bytes)) return "‚Äî";
            const units = ["–ë", "–ö–ë", "–ú–ë", "–ì–ë"];
            let i = 0;
            let v = bytes;
            while (v >= 1024 && i < units.length - 1) {
                v /= 1024;
                i++;
            }
            return `${v.toFixed(v < 10 && i > 0 ? 1 : 0)} ${units[i]}`;
        };

        const setStatus = (text, type = null) => {
            statusEl.textContent = text;
            statusEl.classList.remove("ok", "err");
            if (type) statusEl.classList.add(type);
        };

        const showMeta = (file) => {
            const name = document.createElement("span");
            name.innerHTML = `<b>${file.name}</b> ¬∑ ${fmtSize(file.size)}`;
            const ext = (file.name.split(".").pop() || "").toLowerCase();
            const extChip = document.createElement("span");
            extChip.className = "chip";
            extChip.textContent = ext ? `.${ext}` : "—Ñ–∞–π–ª";

            fileMeta.firstElementChild.replaceWith(name);
            chips.innerHTML = "";
            chips.appendChild(extChip);
        };

        const acceptExt = ["xlsx", "xls", "xlsm", "csv"];
        const validFile = (file) => {
            const ext = (file.name.split(".").pop() || "").toLowerCase();
            if (!acceptExt.includes(ext)) return false;
            const max = 20 * 1024 * 1024; // 20MB
            return file.size <= max;
        };

        const assignFile = (file) => {
            if (!validFile(file)) {
                setStatus(
                    "–ù–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π —Ç–∏–ø –∏–ª–∏ —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π —Ñ–∞–π–ª (–º–∞–∫—Å. 20 –ú–ë).",
                    "err"
                );
                currentFile = null;
                processBtn.disabled = true;
                fileMeta.firstElementChild.textContent = "‚Äî";
                chips.innerHTML = "";
                return;
            }
            currentFile = file;
            showMeta(file);
            processBtn.disabled = false;
            setStatus("–ì–æ—Ç–æ–≤ –∫ –æ–±—Ä–∞–±–æ—Ç–∫–µ");
        };

        chooseBtn.addEventListener("click", () => fileInput.click());
        fileInput.addEventListener("change", (e) => {
            const file = e.target.files && e.target.files[0];
            if (file) assignFile(file);
        });

        // Drag and drop handlers
        ["dragenter", "dragover"].forEach((evt) =>
            dz.addEventListener(evt, (e) => {
                e.preventDefault();
                e.stopPropagation();
                dz.classList.add("dragover");
            })
        );
        ["dragleave", "drop"].forEach((evt) =>
            dz.addEventListener(evt, (e) => {
                e.preventDefault();
                e.stopPropagation();
                dz.classList.remove("dragover");
            })
        );
        dz.addEventListener("drop", (e) => {
            const file =
                e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files[0];
            if (file) assignFile(file);
        });

        // Keyboard activation for accessibility
        dz.addEventListener("keydown", (e) => {
            if (e.key === "Enter" || e.key === " ") {
                e.preventDefault();
                fileInput.click();
            }
        });

        resetBtn.addEventListener("click", () => {
            currentFile = null;
            if (downloadUrl) {
                URL.revokeObjectURL(downloadUrl);
                downloadUrl = null;
            }
            fileInput.value = "";
            processBtn.disabled = true;
            setStatus("–û–∂–∏–¥–∞—é —Ñ–∞–π–ª‚Ä¶");
            fileMeta.firstElementChild.textContent = "‚Äî";
            chips.innerHTML = "";
        });

        // –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è —Ç–µ–ª–µ—Ñ–æ–Ω–∞ (–∫–∞–∫ –≤ server.js)
        const normalizeUaPhone = (phone) => {
            let s = String(phone || "").trim();
            if (!s) return "";
            s = s.replace(/[\s()-]/g, "");
            if (s.startsWith("00")) s = "+" + s.slice(2);
            if (s.startsWith("+380")) return s;
            if (/^380\d{9}$/.test(s)) return "+" + s;
            if (/^0\d{9}$/.test(s)) return "+38" + s;
            if (s.startsWith("+")) return s;
            return s;
        };

        const normalizeEmail = (email) =>
            String(email || "")
            .trim()
            .toLowerCase();

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ —á–µ—Ä–µ–∑ API
        const checkDuplicates = async(parsedData) => {
            setStatus("–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ KeyCRM...");

            try {
                // URL API —Å–µ—Ä–≤–µ—Ä–∞ (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –ª–æ–∫–∞–ª—å–Ω—ã–π –∏–ª–∏ –ø—Ä–æ–¥–∞–∫—à–Ω)
                const isLocalhost = window.location.hostname === 'localhost' ||
                    window.location.hostname === '127.0.0.1' ||
                    window.location.hostname === '';

                const API_URL = isLocalhost ?
                    "http://localhost:3000" // –î–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
                    :
                    "https://keycrm-leads-checker.onrender.com"; // ‚Üê –ó–ê–ú–ï–ù–ò–¢–ï –ø–æ—Å–ª–µ –¥–µ–ø–ª–æ—è –Ω–∞ Render

                console.log(`üåê –û–ø—Ä–µ–¥–µ–ª—ë–Ω —Ä–µ–∂–∏–º: ${isLocalhost ? '–õ–û–ö–ê–õ–¨–ù–´–ô' : '–ü–†–û–î–ê–ö–®–ù'}`);
                console.log(`üîó API URL: ${API_URL}`);

                // –®–ê–ì 1: –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ—Ö –ø–æ–∫—É–ø–∞—Ç–µ–ª–µ–π –∏–∑ KeyCRM
                setStatus("–ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–∫—É–ø–∞—Ç–µ–ª–µ–π –∏–∑ KeyCRM...");
                const buyersResponse = await fetch(`${API_URL}/buyers/all?max=10000`);
                if (!buyersResponse.ok) {
                    throw new Error(`API error: ${buyersResponse.status}`);
                }

                const {
                    data: buyers
                } = await buyersResponse.json();
                console.log("=== BUYERS FROM KEYCRM ===");
                console.log(`–ü–æ–ª—É—á–µ–Ω–æ –ø–æ–∫—É–ø–∞—Ç–µ–ª–µ–π: ${buyers.length}`);
                console.log("–ü–µ—Ä–≤—ã–µ 3 –ø–æ–∫—É–ø–∞—Ç–µ–ª—è:", buyers.slice(0, 3));

                // –®–ê–ì 2: –ü–æ–ª—É—á–∞–µ–º –í–°–ï –∫–æ–º–ø–∞–Ω–∏–∏ –∏–∑ KeyCRM (–æ–¥–∏–Ω —Ä–∞–∑!)
                setStatus("–ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–º–ø–∞–Ω–∏–π –∏–∑ KeyCRM...");
                const companiesResponse = await fetch(`${API_URL}/companies/all?max=5000`);
                if (!companiesResponse.ok) {
                    throw new Error(`API error (companies): ${companiesResponse.status}`);
                }

                const {
                    data: companies
                } = await companiesResponse.json();
                console.log("=== COMPANIES FROM KEYCRM ===");
                console.log(`–ü–æ–ª—É—á–µ–Ω–æ –∫–æ–º–ø–∞–Ω–∏–π: ${companies.length}`);
                console.log("–ü–µ—Ä–≤—ã–µ 3 –∫–æ–º–ø–∞–Ω–∏–∏:", companies.slice(0, 3));

                // –°–æ–∑–¥–∞–µ–º Set –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞ –ø–æ –≤—Å–µ–º –ø–æ–ª—è–º
                const existingPhones = new Set();
                const existingEmails = new Set();
                const existingSocialNetworks = new Set(); // ‚Üê –ù–û–í–û–ï: –¥–ª—è —Å–æ—Ü. —Å–µ—Ç–µ–π

                // –°–æ–∑–¥–∞–µ–º Map –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞ –ü–û–õ–ù–´–• –¥–∞–Ω–Ω—ã—Ö –ø–æ–∫—É–ø–∞—Ç–µ–ª—è –ø–æ —Ä–∞–∑–Ω—ã–º –ø–æ–ª—è–º
                const buyersByPhone = new Map();
                const buyersByEmail = new Map();

                // –ó–∞–ø–æ–ª–Ω—è–µ–º –∏–Ω–¥–µ–∫—Å—ã –∏–∑ buyers (—Ç–µ–ª–µ—Ñ–æ–Ω—ã –∏ email)
                buyers.forEach((buyer) => {
                    // –¢–µ–ª–µ—Ñ–æ–Ω—ã –∏ email
                    buyer.phones.forEach((p) => {
                        existingPhones.add(p);
                        buyersByPhone.set(p, buyer);
                    });
                    buyer.emails.forEach((e) => {
                        existingEmails.add(e);
                        buyersByEmail.set(e, buyer);
                    });
                });

                // –ó–∞–ø–æ–ª–Ω—è–µ–º –∏–Ω–¥–µ–∫—Å—ã –∏–∑ companies (—Å–æ—Ü. —Å–µ—Ç–∏)
                companies.forEach((company) => {
                    // –ò—â–µ–º custom_fields —Å –Ω–∞–∑–≤–∞–Ω–∏–µ–º "–°–æ—Ü—ñ–∞–ª—å–Ω—ñ –º–µ—Ä–µ–∂—ñ"
                    if (company.custom_fields && Array.isArray(company.custom_fields)) {
                        const socialField = company.custom_fields.find(
                            field => field.name === "–°–æ—Ü—ñ–∞–ª—å–Ω—ñ –º–µ—Ä–µ–∂—ñ"
                        );

                        if (socialField && socialField.value) {
                            const socialNetwork = String(socialField.value).trim().toLowerCase();
                            if (socialNetwork) {
                                existingSocialNetworks.add(socialNetwork);
                                console.log(`   ‚úì –ö–æ–º–ø–∞–Ω–∏—è ID ${company.id}: "${socialNetwork}"`);
                            }
                        }
                    }
                });

                console.log(`\nüìä –°–¢–ê–¢–ò–°–¢–ò–ö–ê:`);
                console.log(`   –£–Ω–∏–∫–∞–ª—å–Ω–∏—Ö —Ç–µ–ª–µ—Ñ–æ–Ω—ñ–≤ –≤ KeyCRM: ${existingPhones.size}`);
                console.log(`   –£–Ω–∏–∫–∞–ª—å–Ω–∏—Ö email –≤ KeyCRM: ${existingEmails.size}`);
                console.log(`   –£–Ω–∏–∫–∞–ª—å–Ω–∏—Ö —Å–æ—Ü. –º–µ—Ä–µ–∂ –≤ KeyCRM: ${existingSocialNetworks.size}`);

                setStatus("–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –¥—É–±–ª—ñ–∫–∞—Ç—ñ–≤...");

                console.log("\n=== –ü–û–ß–ê–¢–û–ö –ü–ï–†–ï–í–Ü–†–ö–ò –ö–û–ñ–ù–û–ì–û –ó–ê–ü–ò–°–£ ===");

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—É—é –∑–∞–ø–∏—Å—å –∏–∑ —Ñ–∞–π–ª–∞
                const results = [];

                for (let index = 0; index < parsedData.length; index++) {
                    const row = parsedData[index];

                    // –†–∞–∑–±–∏–≤–∞–µ–º —Ç–µ–ª–µ—Ñ–æ–Ω—ã –Ω–∞ –º–∞—Å—Å–∏–≤, –µ—Å–ª–∏ –∏—Ö –Ω–µ—Å–∫–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é
                    const phoneRaw = row["–¢–µ–ª–µ—Ñ–æ–Ω"] || "";
                    const phones = phoneRaw
                        .split(/[,;]/) // –†–∞–∑–¥–µ–ª—è–µ–º –ø–æ –∑–∞–ø—è—Ç–æ–π –∏–ª–∏ —Ç–æ—á–∫–µ —Å –∑–∞–ø—è—Ç–æ–π
                        .map(p => normalizeUaPhone(p.trim())) // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –∫–∞–∂–¥—ã–π
                        .filter(p => p); // –£–±–∏—Ä–∞–µ–º –ø—É—Å—Ç—ã–µ

                    // –†–∞–∑–±–∏–≤–∞–µ–º email —Ç–æ–∂–µ, –µ—Å–ª–∏ –∏—Ö –Ω–µ—Å–∫–æ–ª—å–∫–æ
                    const emailRaw = row["Email"] || "";
                    const emails = emailRaw
                        .split(/[,;]/)
                        .map(e => normalizeEmail(e.trim()))
                        .filter(e => e);

                    // –ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏ –∏ –ø–æ–ª–Ω–æ–µ –∏–º—è (–¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è)
                    const companyName = (row["–ù–∞–∑–≤–∞ –∫–æ–º–ø–∞–Ω—ñ—ó"] || "").trim().toLowerCase();
                    const fullName = (row["–ü–æ–≤–Ω–µ —ñ–º'—è"] || "").trim().toLowerCase();

                    // –°–æ—Ü. —Å–µ—Ç—å –∏–∑ —Ñ–∞–π–ª–∞ - –∏—â–µ–º –∫–æ–ª–æ–Ω–∫—É –±–µ–∑ —É—á—ë—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞
                    let socialNetworkRaw = "";
                    let socialColumnName = "";

                    // –ò—â–µ–º –∫–æ–ª–æ–Ω–∫—É –ø–æ —á–∞—Å—Ç–∏—á–Ω–æ–º—É —Å–æ–≤–ø–∞–¥–µ–Ω–∏—é (–±–µ–∑ —É—á—ë—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞)
                    const socialKeys = Object.keys(row).filter(key => {
                        const lowerKey = key.toLowerCase();
                        return (lowerKey.includes("—Å–æ—Ü") && lowerKey.includes("–º–µ—Ä–µ–∂"));
                    });

                    if (socialKeys.length > 0) {
                        socialColumnName = socialKeys[0];
                        socialNetworkRaw = row[socialColumnName] || "";
                    }

                    const socialNetwork = socialNetworkRaw.trim().toLowerCase();

                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã
                    const isDuplicateByPhone = phones.some(phone => existingPhones.has(phone));
                    const isDuplicateByEmail = emails.some(email => existingEmails.has(email));
                    const isDuplicateBySocialNetwork = socialNetwork && existingSocialNetworks.has(socialNetwork);

                    // –î–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º (–Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤)
                    const isDuplicateByCompanyName = false;
                    const isDuplicateByFullName = false;

                    // –ó–∞–ø–∏—Å—å —Å—á–∏—Ç–∞–µ—Ç—Å—è –¥—É–±–ª–∏–∫–∞—Ç–æ–º –µ—Å–ª–∏ —Å–æ–≤–ø–∞–¥–∞–µ—Ç –•–û–¢–Ø –ë–´ –û–î–ù–û –ø–æ–ª–µ
                    const isDuplicate = isDuplicateByPhone || isDuplicateByEmail || isDuplicateBySocialNetwork;

                    // –§–æ—Ä–º–∏—Ä—É–µ–º –ø—Ä–∏—á–∏–Ω—É –¥—É–±–ª–∏–∫–∞—Ç–∞
                    const reasons = [];
                    if (isDuplicateByPhone) reasons.push("—Ç–µ–ª–µ—Ñ–æ–Ω");
                    if (isDuplicateByEmail) reasons.push("email");
                    if (isDuplicateBySocialNetwork) reasons.push("—Å–æ—Ü. –º–µ—Ä–µ–∂–∞");

                    // –î–ï–¢–ê–õ–¨–ù–û–ï –õ–û–ì–ò–†–û–í–ê–ù–ò–ï –ö–ê–ñ–î–û–ô –ó–ê–ü–ò–°–ò
                    console.log(`\n--- –ó–∞–ø–∏—Å—å ${index + 1} (—Å—Ç—Ä–æ–∫–∞ Excel: ${index + 2}) ---`);
                    console.log(`üìã –í–°–ï –ö–û–õ–û–ù–ö–ò –í –§–ê–ô–õ–ï:`, Object.keys(row)); // ‚Üê –ù–û–í–û–ï: –ø–æ–∫–∞–∂–µ—Ç –≤—Å–µ –∫–æ–ª–æ–Ω–∫–∏
                    console.log(`üîç –ù–∞–π–¥–µ–Ω–∞ –∫–æ–ª–æ–Ω–∫–∞ –¥–ª—è —Å–æ—Ü. —Å–µ—Ç–∏: "${socialColumnName || '–ù–ï –ù–ê–ô–î–ï–ù–ê'}"`); // ‚Üê –ù–û–í–û–ï
                    console.log(`üìã –ò—Å—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ñ–∞–π–ª–∞:`);
                    console.log(`   –¢–µ–ª–µ—Ñ–æ–Ω: "${phoneRaw || "(–ø—É—Å—Ç–æ)"}"`);
                    console.log(`   Email: "${emailRaw || "(–ø—É—Å—Ç–æ)"}"`);
                    console.log(`   –°–æ—Ü. –º–µ—Ä–µ–∂–∞: "${socialNetworkRaw || "(–ø—É—Å—Ç–æ)"}"`);

                    console.log(`\nüîç –ù–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏:`);
                    console.log(`   –¢–µ–ª–µ—Ñ–æ–Ω—ã (–º–∞—Å—Å–∏–≤): [${phones.map(p => '"' + p + '"').join(", ")}]`);
                    console.log(`   Email (–º–∞—Å—Å–∏–≤): [${emails.map(e => '"' + e + '"').join(", ")}]`);
                    console.log(`   –ö–æ–º–ø–∞–Ω–∏—è –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è: "${companyName || "(–ø—É—Å—Ç–æ)"}"`);
                    console.log(`   –ü–æ–ª–Ω–æ–µ –∏–º—è –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ: "${fullName || "(–ø—É—Å—Ç–æ)"}"`);
                    console.log(`   –°–æ—Ü. –º–µ—Ä–µ–∂–∞ –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è: "${socialNetwork || "(–ø—É—Å—Ç–æ)"}"`); // ‚Üê –ù–û–í–û–ï

                    console.log(`\n‚öñÔ∏è –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å—Ä–∞–≤–Ω–µ–Ω–∏—è —Å KeyCRM:`);
                    console.log(`   –¢–µ–ª–µ—Ñ–æ–Ω –Ω–∞–π–¥–µ–Ω –≤ –±–∞–∑–µ: ${isDuplicateByPhone ? '‚ùå –î–ê (–î–£–ë–õ–ò–ö–ê–¢)' : '‚úÖ –ù–ï–¢ (—É–Ω–∏–∫–∞–ª–µ–Ω)'}`);
                    if (isDuplicateByPhone) {
                        const foundPhones = phones.filter(p => existingPhones.has(p));
                        console.log(`      ‚Üí –ù–∞–π–¥–µ–Ω–Ω—ã–µ —Ç–µ–ª–µ—Ñ–æ–Ω—ã: ${foundPhones.join(", ")}`);
                    }
                    console.log(`   Email –Ω–∞–π–¥–µ–Ω –≤ –±–∞–∑–µ: ${isDuplicateByEmail ? '‚ùå –î–ê (–î–£–ë–õ–ò–ö–ê–¢)' : '‚úÖ –ù–ï–¢ (—É–Ω–∏–∫–∞–ª–µ–Ω)'}`);
                    if (isDuplicateByEmail) {
                        const foundEmails = emails.filter(e => existingEmails.has(e));
                        console.log(`      ‚Üí –ù–∞–π–¥–µ–Ω–Ω—ã–µ email: ${foundEmails.join(", ")}`);
                    }
                    console.log(`   –ö–æ–º–ø–∞–Ω–∏—è –Ω–∞–π–¥–µ–Ω–∞ –≤ –±–∞–∑–µ: ${isDuplicateByCompanyName ? '‚ùå –î–ê (–î–£–ë–õ–ò–ö–ê–¢)' : '‚úÖ –ù–ï–¢ (—É–Ω–∏–∫–∞–ª–µ–Ω)'}`);
                    console.log(`   –ü–æ–ª–Ω–æ–µ –∏–º—è –Ω–∞–π–¥–µ–Ω–æ –≤ –±–∞–∑–µ: ${isDuplicateByFullName ? '‚ùå –î–ê (–î–£–ë–õ–ò–ö–ê–¢)' : '‚úÖ –ù–ï–¢ (—É–Ω–∏–∫–∞–ª–µ–Ω)'}`);
                    console.log(`   –°–æ—Ü. –º–µ—Ä–µ–∂–∞ –Ω–∞–π–¥–µ–Ω–∞ –≤ –±–∞–∑–µ: ${isDuplicateBySocialNetwork ? '‚ùå –î–ê (–î–£–ë–õ–ò–ö–ê–¢)' : '‚úÖ –ù–ï–¢ (—É–Ω–∏–∫–∞–ª–µ–Ω)'}`); // ‚Üê –ù–û–í–û–ï
                    if (isDuplicateBySocialNetwork) {
                        console.log(`      ‚Üí –ù–∞–π–¥–µ–Ω–∞ —Å–æ—Ü. –º–µ—Ä–µ–∂–∞: "${socialNetwork}"`);
                    }
                    console.log(`\nüìä –ò–¢–û–ì:`);
                    if (isDuplicate) {
                        console.log(`   ‚ùå –î–£–ë–õ–ò–ö–ê–¢ - –ø—Ä–∏—á–∏–Ω–∞: ${reasons.join(", ")}`);
                    } else {
                        console.log(`   ‚úÖ –£–ù–ò–ö–ê–õ–¨–ù–ê–Ø –ó–ê–ü–ò–°–¨ - –≤—Å–µ –ø–æ–ª—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ KeyCRM`);
                    }

                    // –ù–∞—Ö–æ–¥–∏–º –ø–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–∫—É–ø–∞—Ç–µ–ª—è –∏–∑ KeyCRM (–ø–æ –ø–µ—Ä–≤–æ–º—É –Ω–∞–π–¥–µ–Ω–Ω–æ–º—É —Å–æ–≤–ø–∞–¥–µ–Ω–∏—é)
                    let keyCRMBuyer = null;
                    if (isDuplicateByPhone && phones.length > 0) {
                        // –ò—â–µ–º –ø–æ –ø–µ—Ä–≤–æ–º—É –Ω–∞–π–¥–µ–Ω–Ω–æ–º—É —Ç–µ–ª–µ—Ñ–æ–Ω—É
                        const foundPhone = phones.find(p => existingPhones.has(p));
                        if (foundPhone) {
                            keyCRMBuyer = buyersByPhone.get(foundPhone);
                        }
                    } else if (isDuplicateByEmail && emails.length > 0) {
                        const foundEmail = emails.find(e => existingEmails.has(e));
                        if (foundEmail) {
                            keyCRMBuyer = buyersByEmail.get(foundEmail);
                        }
                    } else if (isDuplicateByCompanyName) {
                        keyCRMBuyer = buyersByCompanyName.get(companyName);
                    } else if (isDuplicateByFullName) {
                        keyCRMBuyer = buyersByFullName.get(fullName);
                    }
                    // –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: –¥–ª—è isDuplicateBySocialNetwork –ø–æ–∫—É–ø–∞—Ç–µ–ª—å —É–∂–µ –Ω–∞–π–¥–µ–Ω –≤—ã—à–µ –≤ keyCRMBuyerForSocial

                    // –§–æ—Ä–º–∏—Ä—É–µ–º –æ–±—ä–µ–∫—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
                    const result = {
                        ...row,
                        _isDuplicate: isDuplicate,
                        _duplicateReason: reasons.join(", "),
                        _rowNumber: index + 2,
                    };

                    // –ï—Å–ª–∏ –¥—É–±–ª–∏–∫–∞—Ç - –¥–æ–±–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ KeyCRM
                    if (isDuplicate && keyCRMBuyer) {
                        result["[KeyCRM] ID"] = keyCRMBuyer.id || "";
                        result["[KeyCRM] –ù–∞–∑–≤–∞"] = keyCRMBuyer.name || "";
                        result["[KeyCRM] –¢–µ–ª–µ—Ñ–æ–Ω–∏"] = keyCRMBuyer.phones.join(", ") || "";
                        result["[KeyCRM] Email"] = keyCRMBuyer.emails.join(", ") || "";
                        result["[KeyCRM] –°–æ—Ü. –º–µ—Ä–µ–∂–∞"] = keyCRMBuyer.socialNetworks || ""; // ‚Üê –ù–û–í–û–ï
                        result["[KeyCRM] –î–∂–µ—Ä–µ–ª–æ"] = keyCRMBuyer.source || "";
                        result["[KeyCRM] –ú–µ–Ω–µ–¥–∂–µ—Ä"] = keyCRMBuyer.manager || "";
                        result["[KeyCRM] –¢–µ–≥–∏"] = keyCRMBuyer.tags || "";
                        result["[KeyCRM] –ö–æ–º–µ–Ω—Ç–∞—Ä"] = keyCRMBuyer.comment || "";

                        console.log(`\nüîç –ó–Ω–∞–π–¥–µ–Ω–æ –≤ KeyCRM:`);
                        console.log(`   ID: ${keyCRMBuyer.id}`);
                        console.log(`   –ù–∞–∑–≤–∞: ${keyCRMBuyer.name}`);
                        console.log(`   –¢–µ–ª–µ—Ñ–æ–Ω–∏: ${keyCRMBuyer.phones.join(", ")}`);
                        console.log(`   Email: ${keyCRMBuyer.emails.join(", ")}`);
                        console.log(`   –°–æ—Ü. –º–µ—Ä–µ–∂–∞: ${keyCRMBuyer.socialNetworks || "(–Ω–µ–º–∞—î)"}`); // ‚Üê –ù–û–í–û–ï
                    }

                    results.push(result);
                }

                console.log("\n=== –ö–û–ù–ï–¶ –ü–†–û–í–ï–†–ö–ò –ó–ê–ü–ò–°–ï–ô ===\n");

                const duplicates = results.filter((r) => r._isDuplicate);
                const unique = results.filter((r) => !r._isDuplicate);

                console.log("=== –†–ï–ó–£–õ–¨–¢–ê–¢–´ –ü–†–û–í–ï–†–ö–ò ===");
                console.log(`–í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π: ${results.length}`);
                console.log(`–î—É–±–ª–∏–∫–∞—Ç–æ–≤: ${duplicates.length}`);
                console.log(`–£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö: ${unique.length}`);
                if (duplicates.length > 0) {
                    console.log("–ü—Ä–∏–º–µ—Ä—ã –¥—É–±–ª–∏–∫–∞—Ç–æ–≤:");
                    duplicates.slice(0, 5).forEach(d => {
                        console.log(`- –°—Ç—Ä–æ–∫–∞ ${d._rowNumber}: "${d["–ù–∞–∑–≤–∞ –∫–æ–º–ø–∞–Ω—ñ—ó"] || d["–ü–æ–≤–Ω–µ —ñ–º'—è"]}" (–ø—Ä–∏—á–∏–Ω–∞: ${d._duplicateReason})`);
                    });
                }

                return {
                    unique,
                    duplicates,
                    total: results.length
                };
            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤:", error);
                throw new Error(`–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –¥—É–±–ª–∏–∫–∞—Ç—ã: ${error.message}`);
            }
        };

        // –°–æ–∑–¥–∞–Ω–∏–µ Excel —Ñ–∞–π–ª–∞
        const createExcelFile = (data, filename) => {
            // –£–¥–∞–ª—è–µ–º —Å–ª—É–∂–µ–±–Ω—ã–µ –ø–æ–ª—è –ø–µ—Ä–µ–¥ —ç–∫—Å–ø–æ—Ä—Ç–æ–º
            const cleanData = data.map((row) => {
                const {
                    _isDuplicate,
                    _duplicateReason,
                    _rowNumber,
                    ...clean
                } = row;
                return clean;
            });

            // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é –∫–Ω–∏–≥—É
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(cleanData);

            // –î–æ–±–∞–≤–ª—è–µ–º –ª–∏—Å—Ç
            XLSX.utils.book_append_sheet(wb, ws, "–£–Ω–∏–∫–∞–ª—å–Ω—ã–µ –ª–∏–¥—ã");

            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Ñ–∞–π–ª
            const wbout = XLSX.write(wb, {
                bookType: "xlsx",
                type: "array"
            });
            const blob = new Blob([wbout], {
                type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
            });

            // –°–æ–∑–¥–∞–µ–º —Å—Å—ã–ª–∫—É –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            a.remove();
            setTimeout(() => URL.revokeObjectURL(url), 5000);
        };

        processBtn.addEventListener("click", async() => {
            if (!currentFile) return;
            setStatus("–û–±—Ä–∞–±–æ—Ç–∫–∞‚Ä¶");

            try {
                // –ß–∏—Ç–∞–µ–º —Ñ–∞–π–ª –∫–∞–∫ ArrayBuffer
                const arrayBuf = await currentFile.arrayBuffer();
                const ext = (currentFile.name.split(".").pop() || "").toLowerCase();

                let parsedData = [];

                // –ü–∞—Ä—Å–∏–º —Ñ–∞–π–ª –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞
                if (ext === "csv") {
                    // –î–ª—è CSV —Ñ–∞–π–ª–æ–≤
                    const text = new TextDecoder("utf-8").decode(arrayBuf);
                    const lines = text.split("\n").filter((line) => line.trim());

                    if (lines.length > 0) {
                        // –ü–µ—Ä–≤–∞—è —Å—Ç—Ä–æ–∫–∞ - –∑–∞–≥–æ–ª–æ–≤–∫–∏
                        const headers = lines[0]
                            .split(";")
                            .map((h) => h.trim().replace(/^\uFEFF/, ""));

                        // –û—Å—Ç–∞–ª—å–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏ - –¥–∞–Ω–Ω—ã–µ
                        for (let i = 1; i < lines.length; i++) {
                            const values = lines[i].split(";");
                            const row = {};
                            headers.forEach((header, index) => {
                                row[header] = values[index] ? values[index].trim() : "";
                            });
                            parsedData.push(row);
                        }
                    }
                } else {
                    // –î–ª—è Excel —Ñ–∞–π–ª–æ–≤ (.xlsx, .xls, .xlsm)
                    const workbook = XLSX.read(arrayBuf, {
                        type: "array",
                    });

                    // –ë–µ—Ä–µ–º –ø–µ—Ä–≤—ã–π –ª–∏—Å—Ç
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];

                    // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ JSON (–º–∞—Å—Å–∏–≤ –æ–±—ä–µ–∫—Ç–æ–≤)
                    parsedData = XLSX.utils.sheet_to_json(worksheet, {
                        defval: "", // –ü—É—Å—Ç—ã–µ —è—á–µ–π–∫–∏ –±—É–¥—É—Ç –ø—É—Å—Ç—ã–º–∏ —Å—Ç—Ä–æ–∫–∞–º–∏
                        raw: false, // –í—Å–µ –∑–Ω–∞—á–µ–Ω–∏—è –∫–∞–∫ —Å—Ç—Ä–æ–∫–∏
                    });
                }

                console.log("=== PARSED DATA ===");
                console.log(`–í—Å–µ–≥–æ —Å—Ç—Ä–æ–∫ –≤ —Ñ–∞–π–ª–µ: ${parsedData.length}`);

                if (parsedData.length === 0) {
                    setStatus("–§–∞–π–ª –ø—É—Å—Ç–æ–π –∏–ª–∏ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç", "err");
                    return;
                }

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã —á–µ—Ä–µ–∑ API
                const {
                    unique,
                    duplicates,
                    total
                } = await checkDuplicates(
                    parsedData
                );

                // –°–æ–∑–¥–∞–µ–º Excel —Ñ–∞–π–ª —Ç–æ–ª—å–∫–æ —Å —É–Ω–∏–∫–∞–ª—å–Ω—ã–º–∏ –∑–∞–ø–∏—Å—è–º–∏
                const baseFilename = currentFile.name.replace(/\.[^.]+$/, "");
                const newFilename = `${baseFilename}_–±–µ–∑_–¥—É–±–ª–µ–π.xlsx`;
                let reportFilename = null;

                createExcelFile(unique, newFilename);

                // –¢–∞–∫–∂–µ —Å–æ–∑–¥–∞–µ–º –æ—Ç—á–µ—Ç —Å –¥—É–±–ª–∏–∫–∞—Ç–∞–º–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
                if (duplicates.length > 0) {
                    reportFilename = `${baseFilename}_–¥—É–±–ª–∏–∫–∞—Ç—ã_–æ—Ç—á–µ—Ç.xlsx`;
                    createExcelFile(duplicates, reportFilename);
                }

                setStatus(
                    `‚úî –ì–æ—Ç–æ–≤–æ! –£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö: ${unique.length} –∏–∑ ${total}. –î—É–±–ª–µ–π: ${duplicates.length}`,
                    "ok"
                );

                console.log("=== –§–ê–ô–õ–´ –°–û–ó–î–ê–ù–´ ===");
                console.log(
                    `1. ${newFilename} - ${unique.length} —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π`
                );
                if (duplicates.length > 0 && reportFilename) {
                    console.log(
                        `2. ${reportFilename} - ${duplicates.length} –¥—É–±–ª–∏–∫–∞—Ç–æ–≤`
                    );
                }
            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ:", error);
                setStatus(`–û—à–∏–±–∫–∞: ${error.message}`, "err");
            }
        });

        templateBtn.addEventListener("click", () => {
            // TODO: –ø–æ–¥–º–µ–Ω–∏—Ç—å –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–π .xlsx —à–∞–±–ª–æ–Ω Gravity.
            // –°–µ–π—á–∞—Å –æ—Ç–¥–∞–¥–∏–º –ø—É—Å—Ç–æ–π CSV —Å –∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏ –ø–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç—É ‚Äî —á—Ç–æ–±—ã –±—ã–ª–æ —Å —á–µ–≥–æ –Ω–∞—á–∞—Ç—å.
            const headers = [
                "–ù–∞–∑–≤–∞ –∫–æ–º–ø–∞–Ω—ñ—ó",
                "–¢–µ–ª–µ—Ñ–æ–Ω",
                "–†–µ–≥—ñ–æ–Ω –æ—Å–Ω–æ–≤–Ω–∏–π",
                "–û—Å–Ω–æ–≤–Ω–∏–π –≤–∏–¥ –¥—ñ—è–ª—å–Ω–æ—Å—Ç—ñ",
                "–ö–ª–∞—Å –æ–±'—î–∫—Ç—ñ–≤ –æ—Å–Ω–æ–≤–Ω–∏–π",
                "–û—Å–Ω–æ–≤–Ω–∏–π —Ç–∏–ø –æ–±'—î–∫—Ç—ñ–≤",
                "–ü—Ä–æ—Ñ–µ—Å—ñ–π–Ω—ñ—Å—Ç—å",
                "–ó–∞—Ü—ñ–∫–∞–≤–ª–µ–Ω—ñ—Å—Ç—å —É —Å–ø—ñ–≤–ø—Ä–∞—Ü—ñ",
                "–†–æ–∑–º—ñ—Ä –∫–æ–º–ø–∞–Ω—ñ—ó",
                "–ü–æ–≤–Ω–µ —ñ–º'—è",
                "–ù–∞–∑–≤–∞ –ª—ñ–¥–∞",
                "–î–∂–µ—Ä–µ–ª–æ",
                "–î–æ–¥–∞—Ç–∫–æ–≤—ñ –≤–∏–¥–∏ –¥—ñ—è–ª—å–Ω–æ—Å—Ç—ñ",
                "–†–µ–≥—ñ–æ–Ω–∏ –¥–æ–¥–∞—Ç–∫–æ–≤—ñ",
                "–ö–ª–∞—Å –æ–±'—î–∫—Ç—ñ–≤ –¥–æ–¥–∞—Ç–∫–æ–≤–∏–π",
                "–î–æ–¥–∞—Ç–∫–æ–≤–∏–π —Ç–∏–ø –æ–±'—î–∫—Ç—ñ–≤",
                "–î–æ—Å–≤—ñ–¥ —Ä–æ–±–æ—Ç–∏ (—Ä–æ–∫—ñ–≤)",
                "–°–æ—Ü—ñ–∞–ª—å–Ω—ñ –º–µ—Ä–µ–∂—ñ(–ö–æ–º–ø–∞–Ω—ñ—ó)",
                "Email",
                "–°–æ—Ü—ñ–∞–ª—å–Ω—ñ –º–µ—Ä–µ–∂—ñ(–ª—é–¥–∏–Ω–∞)",
                "–°–æ—Ü. –ú–µ—Ä–µ–∂–∞", // ‚Üê –ù–û–í–û–ï: –¥–æ–±–∞–≤–ª–µ–Ω–æ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤
            ];
            const csv = "\uFEFF" + headers.join(";") + "\n";
            const blob = new Blob([csv], {
                type: "text/csv;charset=utf-8",
            });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = "gravity_template.csv";
            document.body.appendChild(a);
            a.click();
            a.remove();
            setTimeout(() => URL.revokeObjectURL(url), 5000);
        });
    </script>
</body>

</html>